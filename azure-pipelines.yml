trigger:
  branches:
    include:
      - main

pool:
  name: ss-vm-agent-pool

variables:
  imageName: sethumadavacr.azurecr.io/capstone:$(Build.BuildId)
  azureServiceConnection: 'terraform-service-connection'
  acrServiceConnection: 'acr-service-connection'
  sonarConnection: 'sonar-capstone'
  terraformDirectory: '.'

# =======================
# 1. SonarCloud Analysis
# =======================
stages:
- stage: SonarCloud
  displayName: 'SonarCloud Code Analysis'
  jobs:
    - job: Sonar
      steps:
        - task: SonarCloudPrepare@1
          inputs:
            SonarCloud: $(sonarConnection)
            organization: 'devuser130746'                    # âœ… Your SonarCloud org
            scannerMode: 'CLI'
            configMode: 'manual'
            cliProjectKey: 'capstone'
            cliProjectName: 'capstone'
            cliSources: '.'

        - script: |
            sonar-scanner \
              -Dsonar.projectKey=capstone \
              -Dsonar.organization=devuser130746 \
              -Dsonar.sources=. \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$(SONAR_TOKEN)
          displayName: 'Run SonarCloud Scanner'

        - task: SonarCloudPublish@1
          inputs:
            pollingTimeoutSec: '300'

# ============================
# 2. Docker Build & Push Stage
# ============================
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image'
  dependsOn: SonarCloud
  jobs:
    - job: Build
      steps:
        - task: Docker@2
          displayName: 'Login to ACR'
          inputs:
            command: login
            containerRegistry: $(acrServiceConnection)

        - task: Docker@2
          displayName: 'Build Docker Image'
          inputs:
            command: build
            Dockerfile: '**/Dockerfile'
            tags: |
              $(imageName)

        - task: Docker@2
          displayName: 'Push Docker Image'
          inputs:
            command: push
            tags: |
              $(imageName)

# ================================
# 3. Terraform Infra Provisioning
# ================================
- stage: Terraform
  displayName: 'Terraform Provisioning'
  dependsOn: BuildAndPush
  jobs:
    - job: TerraformApply
      steps:
        - task: AzureCLI@2
          displayName: 'Terraform Init and Apply'
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: bash
            scriptLocation: inlineScript
            workingDirectory: $(terraformDirectory)
            inlineScript: |
              terraform init -upgrade
              terraform plan -out=tfplan
              terraform apply -auto-approve tfplan

# =========================================
# 4. Deploy to Two AKS Clusters (Same RG)
# =========================================
- stage: DeployToAKS
  displayName: 'Deploy to Both AKS Clusters'
  dependsOn: Terraform
  jobs:
    - job: DeployToCluster1
      displayName: 'Deploy to AKS Cluster 1 (VNET1)'
      steps:
        - task: AzureCLI@2
          displayName: 'Get AKS Credentials - Cluster 1'
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az aks get-credentials --resource-group sethu-rg --name sethu-aks-cluster-vnet1 --overwrite-existing

        - script: |
            sed -i "s|__CONTAINER_TAG__|$(imageName)|g" manifests/deployment.yml
            kubectl apply -f manifests/
          displayName: 'Deploy to AKS Cluster 1'

    - job: DeployToCluster2
      displayName: 'Deploy to AKS Cluster 2 (VNET2)'
      dependsOn: DeployToCluster1
      steps:
        - task: AzureCLI@2
          displayName: 'Get AKS Credentials - Cluster 2'
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az aks get-credentials --resource-group sethu-rg --name sethu-aks-cluster-vnet2 --overwrite-existing

        - script: |
            sed -i "s|__CONTAINER_TAG__|$(imageName)|g" manifests/deployment.yml
            kubectl apply -f manifests/
          displayName: 'Deploy to AKS Cluster 2'
